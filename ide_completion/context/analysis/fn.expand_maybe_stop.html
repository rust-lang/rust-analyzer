<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Expand attributes and macro calls at the current cursor position for both the original file and fake file repeatedly. As soon as one of the two expansions fail we stop so the original and speculative states stay in sync."><title>expand_maybe_stop in ide_completion::context::analysis - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-ca0dd0c4.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="ide_completion" data-themes="" data-resource-suffix="" data-rustdoc-version="1.93.1 (01f6ddf75 2026-02-11)" data-channel="1.93.1" data-search-js="search-9e2438ea.js" data-stringdex-js="stringdex-a3946164.js" data-settings-js="settings-c38705f0.js" ><script src="../../../static.files/storage-e2aeef58.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-a410ff4d.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">expand_maybe_stop</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../ide_completion/index.html">ide_<wbr>completion</a><span class="version">0.0.0</span></h2></div><div class="sidebar-elems"><div id="rustdoc-modnav"><h2><a href="index.html">In ide_<wbr>completion::<wbr>context::<wbr>analysis</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../../index.html">ide_completion</a>::<wbr><a href="../index.html">context</a>::<wbr><a href="index.html">analysis</a></div><h1>Function <span class="fn">expand_<wbr>maybe_<wbr>stop</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/ide_completion/context/analysis.rs.html#132-170">Source</a> </span></div><pre class="rust item-decl"><code>fn expand_maybe_stop(
    sema: &amp;Semantics&lt;'_, <a class="struct" href="../../../ide_db/struct.RootDatabase.html" title="struct ide_db::RootDatabase">RootDatabase</a>&gt;,
    original_file: InFile&lt;SyntaxNode&gt;,
    speculative_file: SyntaxNode,
    original_offset: TextSize,
    fake_ident_token: SyntaxToken,
    relative_offset: TextSize,
) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.93.1/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="struct.ExpansionResult.html" title="struct ide_completion::context::analysis::ExpansionResult">ExpansionResult</a>&gt;</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Expand attributes and macro calls at the current cursor position for both the original file
and fake file repeatedly. As soon as one of the two expansions fail we stop so the original
and speculative states stay in sync.</p>
<p>We do this by recursively expanding all macros and picking the best possible match. We cannot just
choose the first expansion each time because macros can expand to something that does not include
our completion marker, e.g.:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">â“˜</a><pre class="rust rust-example-rendered"><code><span class="macro">macro_rules!</span> helper { (<span class="macro-nonterminal">$v</span>:ident) =&gt; {} }
<span class="macro">macro_rules!</span> my_macro {
    (<span class="macro-nonterminal">$v</span>:ident) =&gt; {
        <span class="macro">helper!</span>(<span class="macro-nonterminal">$v</span>);
        <span class="macro-nonterminal">$v
    </span>};
}

<span class="macro">my_macro!</span>(complete_me_here);</code></pre></div>
<p>If we would expand the first thing we encounter only (which in fact this method used to do), we would
be unable to complete here, because we would be walking directly into the void. So we instead try
<em>every</em> possible path.</p>
<p>This can also creates discrepancies between the speculative and real expansions: because we insert
tokens, we insert characters, which means if we try the second occurrence it may not be at the same
position in the original and speculative file. We take an educated guess here, and for each token
that we check, we subtract <code>COMPLETION_MARKER.len()</code>. This may not be accurate because proc macros
can insert the text of the completion marker in other places while removing the span, but this is
the best we can do.</p>
</div></details></section></div></main></body></html>